package test

import (
	"strings"
	"testing"

	"github.com/tmck-code/go-ansi-convert/src/ansi-convert/convert"
	"github.com/tmck-code/go-ansi-convert/test"
)

// Test ANSI line reversal -----------------------------------------------------
//
// These are smaller "unit" tests for ANSI line reversal.
// - reverse individual lines
// - reverse multiple (newline separated) lines

func TestFlipHorizontal(t *testing.T) {
	testCases := []struct {
		name     string
		input    string
		expected [][]convert.ANSILineToken
	}{
		{
			name: "Single line with ANSI colours",
			// The AAA has a purple fg, and the XX has a red bg
			input: "\x1b[38;5;129mAAA \x1b[48;5;160m XX \x1b[0m",
			// expected: "\x1b[0m\x1b[38;5;129m\x1b[48;5;160m XX \x1b[49m AAA\x1b[0m",
			expected: [][]convert.ANSILineToken{
				{
					{FG: "\x1b[38;5;129m", BG: "\x1b[48;5;160m", T: " XX "},
					{FG: "\x1b[38;5;129m", BG: "\x1b[49m", T: " AAA"},
				},
			},
		},
		{
			name: "Multi-line with ANSI colours",
			// purple fg, red bg
			// the 4 spaces after AAA should have a purple fg, and no bg
			input: "\x1b[38;5;129mAAA    \x1b[48;5;160m XX \x1b[0m",
			// expected: "\x1b[0m\x1b[38;5;129m\x1b[48;5;160m XX \x1b[0m\x1b[38;5;129m    AAA\x1b[0m",
			expected: [][]convert.ANSILineToken{
				{
					{FG: "\x1b[38;5;129m", BG: "\x1b[48;5;160m", T: " XX "},
					{FG: "\x1b[38;5;129m", BG: "\x1b[49m", T: "    AAA"},
				},
			},
		},
		{
			name: "Multi-line with trailing spaces",
			// The AAA has a purple fg, the XX has a red bg
			input: "  \x1b[38;5;129mAAA \x1b[48;5;160m XY \x1b[0m  ",
			// The AAA should still have a purple fg, and the XX should still have a red bg
			expected: [][]convert.ANSILineToken{
				{
					{FG: "\x1b[0m", BG: "", T: "  "},
					{FG: "\x1b[38;5;129m", BG: "\x1b[48;5;160m", T: " YX "},
					{FG: "\x1b[38;5;129m", BG: "\x1b[49m", T: " AAA"},
					{FG: "", BG: "", T: "  "},
				},
			},
		},
		{
			name:  "Multi-line with colour continuation",
			input: "\x1b[38;5;160m▄ \x1b[38;5;46m▄\n▄ \x1b[38;5;190m▄",
			// expected: "\x1b[0m\x1b[38;5;46m▄\x1b[38;5;160m ▄\n\x1b[38;5;190m▄\x1b[38;5;46m ▄\x1b[0m",
			expected: [][]convert.ANSILineToken{
				{
					{FG: "\x1b[38;5;46m", BG: "", T: "▄"},
					{FG: "\x1b[38;5;160m", BG: "", T: " ▄"},
				},
				{
					{FG: "\x1b[38;5;190m", BG: "", T: "▄"},
					{FG: "\x1b[38;5;46m", BG: "", T: " ▄"},
				},
			},
		},
		{
			// 	// Test ANSI pokemon reversal --------------------------------------------------
			// 	//
			// 	// These are larger "integration" tests for reversing ANSI strings.
			// 	// - reverse pokemon sprite (with & without ANSI colours)
			name: "flip pikachu without colour",
			input: strings.Join(
				[]string{
					"         ▄▄          ▄▄",
					"        ▄▄▄     ▄▄▄▄▄▄ ▄▄",
					"       ▄  ▄▀ ▄▄▄  ▄▄   ▄▀",
					"     ▄▄▄   ▄▄  ▄▄    ▄▀",
					"    ▄▄   ▄▄▄  ▄ ▀▄  ▄▄",
					"    ▀▄▄   ▄▄▄   ▄▄▄ ▄▀",
					"    ▀▄▄▄▄▄ ▄▄   ▄▄▄▄▄",
					"           ▄▄▄▄  ▄▄▀",
					"         ▀▄▄▄    ▄▀",
					"             ▀▀▄▀",
				},
				"\n",
			),
			expected: [][]convert.ANSILineToken{
				{{"", "", "", "  ▄▄          ▄▄         "}},
				{{"", "", "", "▄▄ ▄▄▄▄▄▄     ▄▄▄        "}},
				{{"", "", "", "▀▄   ▄▄  ▄▄▄ ▀▄  ▄       "}},
				{{"", "", "", "  ▀▄    ▄▄  ▄▄   ▄▄▄     "}},
				{{"", "", "", "   ▄▄  ▄▀ ▄  ▄▄▄   ▄▄    "}},
				{{"", "", "", "   ▀▄ ▄▄▄   ▄▄▄   ▄▄▀    "}},
				{{"", "", "", "    ▄▄▄▄▄   ▄▄ ▄▄▄▄▄▀    "}},
				{{"", "", "", "     ▀▄▄  ▄▄▄▄           "}},
				{{"", "", "", "      ▀▄    ▄▄▄▀         "}},
				{{"", "", "", "        ▀▄▀▀             "}},
			},
		},
		{
			name: "flip pikachu with colour",
			input: strings.Join(
				[]string{
					"    \x1b[49m     \x1b[38;5;16m▄\x1b[48;5;16m\x1b[38;5;232m▄ \x1b[49m         \x1b[38;5;16m▄▄",
					"        ▄\x1b[48;5;16m\x1b[38;5;94m▄\x1b[48;5;232m▄\x1b[48;5;16m \x1b[49m    \x1b[38;5;16m▄▄▄▄\x1b[48;5;16m\x1b[38;5;214m▄\x1b[48;5;214m\x1b[38;5;94m▄\x1b[48;5;94m \x1b[48;5;16m▄\x1b[49m\x1b[38;5;16m▄",
					"       ▄\x1b[48;5;16m \x1b[48;5;94m \x1b[48;5;58m▄\x1b[49m▀ ▄\x1b[48;5;16m\x1b[38;5;214m▄▄\x1b[48;5;232m  \x1b[38;5;94m▄\x1b[48;5;214m▄\x1b[48;5;94m   \x1b[38;5;16m▄\x1b[49m▀",
					"     ▄\x1b[48;5;16m\x1b[38;5;214m▄\x1b[48;5;94m▄\x1b[48;5;214m   \x1b[48;5;16m▄\x1b[38;5;58m▄\x1b[48;5;214m  \x1b[38;5;232m▄\x1b[48;5;232m\x1b[38;5;94m▄\x1b[48;5;94m    \x1b[38;5;16m▄\x1b[49m▀",
					"    ▄\x1b[48;5;16m\x1b[38;5;214m▄\x1b[48;5;214m   \x1b[38;5;94m▄\x1b[48;5;94m\x1b[38;5;231m▄\x1b[48;5;214m\x1b[38;5;16m▄  \x1b[48;5;58m\x1b[38;5;214m▄\x1b[48;5;16m \x1b[49m\x1b[38;5;16m▀\x1b[48;5;94m▄  \x1b[48;5;16m\x1b[38;5;94m▄\x1b[49m\x1b[38;5;16m▄",
					"    ▀\x1b[48;5;214m▄\x1b[48;5;58m\x1b[38;5;214m▄\x1b[48;5;214m   \x1b[48;5;16m▄\x1b[48;5;232m\x1b[38;5;196m▄\x1b[48;5;214m▄   \x1b[48;5;16m\x1b[38;5;214m▄\x1b[49m\x1b[38;5;16m▄\x1b[48;5;16m\x1b[38;5;94m▄\x1b[48;5;94m \x1b[38;5;16m▄\x1b[49m▀",
					"    ▀\x1b[48;5;94m▄\x1b[48;5;232m▄\x1b[48;5;94m▄\x1b[48;5;214m\x1b[38;5;94m▄▄ \x1b[48;5;196m\x1b[38;5;214m▄\x1b[38;5;232m▄\x1b[48;5;214m   \x1b[48;5;88m\x1b[38;5;214m▄\x1b[48;5;232m▄\x1b[48;5;52m\x1b[38;5;232m▄\x1b[48;5;16m\x1b[38;5;52m▄\x1b[49m\x1b[38;5;16m▄",
					"        \x1b[48;5;16m \x1b[48;5;94m  \x1b[48;5;232m\x1b[38;5;94m▄\x1b[48;5;214m\x1b[38;5;232m▄▄\x1b[48;5;232m\x1b[38;5;214m▄\x1b[48;5;214m  \x1b[48;5;88m▄\x1b[48;5;232m\x1b[38;5;16m▄\x1b[49m▀",
					"         ▀\x1b[48;5;94m▄▄\x1b[48;5;214m▄    \x1b[48;5;232m▄\x1b[49m▀",
					"             ▀▀\x1b[48;5;214m▄\x1b[49m▀\x1b[39m\x1b[39m",
				},
				"\n",
			),
			expected: [][]convert.ANSILineToken{
				{{"", "", "", "  "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄▄"}, {"\x1b[38;5;232m", "\x1b[49m", "", "         "}, {"\x1b[38;5;232m", "\x1b[48;5;16m", "", " ▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄"}, {"", "\x1b[49m", "", "     "}, {"", "\x1b[49m", "", "    "}},
				{{"\x1b[38;5;16m", "\x1b[49m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;94m", "", " "}, {"\x1b[38;5;94m", "\x1b[48;5;214m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄▄▄▄"}, {"\x1b[38;5;94m", "\x1b[49m", "", "    "}, {"\x1b[38;5;94m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;94m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄        "}},
				{{"\x1b[38;5;16m", "\x1b[49m", "", "▀"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;94m", "", "   "}, {"\x1b[38;5;94m", "\x1b[48;5;214m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;232m", "", "  "}, {"\x1b[38;5;214m", "\x1b[48;5;16m", "", "▄▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄ ▀"}, {"\x1b[38;5;16m", "\x1b[48;5;58m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", " "}, {"\x1b[38;5;16m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄       "}},
				{{"", "", "", "  "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;94m", "", "    "}, {"\x1b[38;5;94m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;232m", "\x1b[48;5;214m", "", "▄"}, {"\x1b[38;5;58m", "\x1b[48;5;214m", "", "  "}, {"\x1b[38;5;58m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;214m", "", "   "}, {"\x1b[38;5;214m", "\x1b[48;5;94m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄     "}},
				{{"", "", "", "   "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", "  ▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀"}, {"\x1b[38;5;214m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;214m", "\x1b[48;5;58m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;214m", "", "  ▄"}, {"\x1b[38;5;231m", "\x1b[48;5;94m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;214m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;214m", "", "   "}, {"\x1b[38;5;214m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄    "}},
				{{"", "", "", "   "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;94m", "", " "}, {"\x1b[38;5;94m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;196m", "\x1b[48;5;214m", "", "   ▄"}, {"\x1b[38;5;196m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;214m", "", "   "}, {"\x1b[38;5;214m", "\x1b[48;5;58m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;214m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀    "}},
				{{"", "", "", "    "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄"}, {"\x1b[38;5;52m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;232m", "\x1b[48;5;52m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;88m", "", "▄"}, {"\x1b[38;5;232m", "\x1b[48;5;214m", "", "   "}, {"\x1b[38;5;232m", "\x1b[48;5;196m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;196m", "", "▄"}, {"\x1b[38;5;94m", "\x1b[48;5;214m", "", " ▄▄"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀    "}},
				{{"", "", "", "     "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀"}, {"\x1b[38;5;16m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;88m", "", "▄"}, {"\x1b[38;5;214m", "\x1b[48;5;214m", "", "  "}, {"\x1b[38;5;214m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;232m", "\x1b[48;5;214m", "", "▄▄"}, {"\x1b[38;5;94m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", "  "}, {"\x1b[38;5;16m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;16m", "\x1b[49m", "", "        "}},
				{{"", "", "", "      "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀"}, {"\x1b[38;5;16m", "\x1b[48;5;232m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;214m", "", "    ▄"}, {"\x1b[38;5;16m", "\x1b[48;5;94m", "", "▄▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀         "}},
				{{"", "", "", "        "}, {"\x1b[39m", "\x1b[49m", "", ""}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀"}, {"\x1b[38;5;16m", "\x1b[48;5;214m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀▀             "}},
			},
		},
		{
			name: "flip egg with colour",
			input: strings.Join(
				[]string{
					"     \x1b[49m   \x1b[38;5;16m▄▄\x1b[48;5;16m\x1b[38;5;142m▄▄▄\x1b[49m\x1b[38;5;16m▄▄",
					"      ▄\x1b[48;5;16m\x1b[38;5;58m▄\x1b[48;5;58m\x1b[38;5;70m▄\x1b[48;5;70m \x1b[48;5;227m    \x1b[48;5;237m\x1b[38;5;227m▄\x1b[48;5;16m\x1b[38;5;237m▄\x1b[49m\x1b[38;5;16m▄",
					"     ▄\x1b[48;5;16m\x1b[38;5;237m▄\x1b[48;5;70m\x1b[38;5;227m▄▄\x1b[48;5;227m    \x1b[38;5;70m▄▄\x1b[48;5;142m \x1b[48;5;16m\x1b[38;5;237m▄\x1b[49m\x1b[38;5;16m▄",
					"     \x1b[48;5;16m \x1b[48;5;227m       \x1b[48;5;70m\x1b[38;5;227m▄\x1b[38;5;58m▄\x1b[48;5;58m \x1b[48;5;142m \x1b[48;5;16m \x1b[49m",
					"     \x1b[48;5;16m \x1b[48;5;142m\x1b[38;5;237m▄\x1b[48;5;227m\x1b[38;5;142m▄\x1b[48;5;70m  \x1b[48;5;227m▄▄\x1b[38;5;58m▄\x1b[48;5;142m▄▄ \x1b[38;5;237m▄\x1b[48;5;16m \x1b[49m",
					"      \x1b[48;5;16m \x1b[48;5;142m▄   \x1b[48;5;58m    \x1b[38;5;234m▄\x1b[48;5;16m \x1b[49m",
					"       \x1b[38;5;16m▀▀\x1b[48;5;142m▄▄▄\x1b[48;5;58m▄▄\x1b[49m▀▀\x1b[39m\x1b[39m",
				},
				"\n",
			),
			expected: [][]convert.ANSILineToken{
				{{"", "", "", "   "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄▄"}, {"\x1b[38;5;142m", "\x1b[48;5;16m", "", "▄▄▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄▄"}, {"", "\x1b[49m", "", "   "}, {"", "\x1b[49m", "", "     "}},
				{{"", "", "", " "}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄"}, {"\x1b[38;5;237m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;227m", "\x1b[48;5;237m", "", "▄"}, {"\x1b[38;5;70m", "\x1b[48;5;227m", "", "    "}, {"\x1b[38;5;70m", "\x1b[48;5;70m", "", " "}, {"\x1b[38;5;70m", "\x1b[48;5;58m", "", "▄"}, {"\x1b[38;5;58m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄      "}},
				{{"\x1b[38;5;16m", "\x1b[49m", "", "▄"}, {"\x1b[38;5;237m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;70m", "\x1b[48;5;142m", "", " "}, {"\x1b[38;5;70m", "\x1b[48;5;227m", "", "▄▄"}, {"\x1b[38;5;227m", "\x1b[48;5;227m", "", "    "}, {"\x1b[38;5;227m", "\x1b[48;5;70m", "", "▄▄"}, {"\x1b[38;5;237m", "\x1b[48;5;16m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▄     "}},
				{{"\x1b[38;5;58m", "\x1b[49m", "", ""}, {"\x1b[38;5;58m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;58m", "\x1b[48;5;142m", "", " "}, {"\x1b[38;5;58m", "\x1b[48;5;58m", "", " "}, {"\x1b[38;5;58m", "\x1b[48;5;70m", "", "▄"}, {"\x1b[38;5;227m", "\x1b[48;5;70m", "", "▄"}, {"\x1b[38;5;16m", "\x1b[48;5;227m", "", "       "}, {"\x1b[38;5;16m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;16m", "\x1b[49m", "", "     "}},
				{{"\x1b[38;5;237m", "\x1b[49m", "", ""}, {"\x1b[38;5;237m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;237m", "\x1b[48;5;142m", "", "▄"}, {"\x1b[38;5;58m", "\x1b[48;5;142m", "", " ▄▄"}, {"\x1b[38;5;58m", "\x1b[48;5;227m", "", "▄"}, {"\x1b[38;5;142m", "\x1b[48;5;227m", "", "▄▄"}, {"\x1b[38;5;142m", "\x1b[48;5;70m", "", "  "}, {"\x1b[38;5;142m", "\x1b[48;5;227m", "", "▄"}, {"\x1b[38;5;237m", "\x1b[48;5;142m", "", "▄"}, {"\x1b[38;5;58m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;58m", "\x1b[49m", "", "     "}},
				{{"", "", "", " "}, {"\x1b[38;5;234m", "\x1b[49m", "", ""}, {"\x1b[38;5;234m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;234m", "\x1b[48;5;58m", "", "▄"}, {"\x1b[38;5;237m", "\x1b[48;5;58m", "", "    "}, {"\x1b[38;5;237m", "\x1b[48;5;142m", "", "   ▄"}, {"\x1b[38;5;237m", "\x1b[48;5;16m", "", " "}, {"\x1b[38;5;237m", "\x1b[49m", "", "      "}},
				{{"", "", "", "  "}, {"\x1b[39m", "\x1b[49m", "", ""}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀▀"}, {"\x1b[38;5;16m", "\x1b[48;5;58m", "", "▄▄"}, {"\x1b[38;5;16m", "\x1b[48;5;142m", "", "▄▄▄"}, {"\x1b[38;5;16m", "\x1b[49m", "", "▀▀"}, {"\x1b[38;5;234m", "\x1b[49m", "", "       "}},
			},
		},
	}
	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			result := convert.FlipHorizontal(convert.TokeniseANSIString(tc.input))
			test.PrintANSITestResults(tc.input, tc.expected, result, t)

			test.Assert(tc.expected, result, t)
		})
	}
}
